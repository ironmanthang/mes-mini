generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
// --- ENUM DEFINITIONS ---

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum OrderStatus {
  DRAFT               
  PENDING
  APPROVED            // Added
  PROCESSING
  PARTIALLY_RECEIVED  // Added: Critical for real purchasing
  SHIPPED
  COMPLETED
  CANCELLED
}

enum ProductionStatus {
  DRAFT               
  REQUESTED
  APPROVED
  IN_PROGRESS
  COMPLETED
  CLOSED
  CANCELLED
}

enum ProductInstanceStatus {
  IN_STOCK
  SOLD
  IN_REPAIR
  SCRAPPED           
  RETURNED
}

enum EmployeeStatus {
  ACTIVE      
  INACTIVE    
  TERMINATED  
}

enum QualityCheckResult {
  PASSED
  FAILED
  NEEDS_REWORK
}

enum InventoryTransactionType {
  IMPORT_PO         // From Supplier
  EXPORT_PRODUCTION // To Line (Material Issue)
  IMPORT_PRODUCTION // From Line (Finished Goods)
  EXPORT_SALES      // To Customer
  TRANSFER
  ADJUSTMENT
  RETURN
}

enum RequestStatus {     // NEW ENUM for Module C
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}
// 1. Bảng employees (Nhân viên)
model Employee {
  employeeId             Int                     @id @default(autoincrement()) @map("employee_id")
  fullName               String                  @map("full_name")
  username               String                  @unique
  password               String
  email                  String                  @unique
  phoneNumber            String                  @unique @map("phone_number")
  address                String?                   
  dateOfBirth            DateTime?               @map("date_of_birth") 
  
  hireDate               DateTime                @map("hire_date")
  terminationDate        DateTime?               @map("termination_date")
  status                 EmployeeStatus          @default(ACTIVE)

  roles                  EmployeeRole[]
  createdWorkOrders      WorkOrder[]
  createdProductionReqs  ProductionRequest[]
  managedSalesOrders     SalesOrder[]  
  createdMaterialReqs    MaterialExportRequest[] @relation("Requester")
  approvedMaterialReqs   MaterialExportRequest[] @relation("Approver")
  performedQualityChecks QualityCheck[]
  inventoryTransactions  InventoryTransaction[]
  createdPurchaseOrders  PurchaseOrder[] @relation("POCreator")  
  approvedPurchaseOrders PurchaseOrder[] @relation("POApprover")

  createdAt              DateTime                @default(now()) @map("created_at")
  updatedAt              DateTime                @updatedAt @map("updated_at")

  @@map("employees")
  @@index([status])
}

// 2. Bảng roles (Vai trò)
model Role {
  roleId    Int            @id @default(autoincrement()) @map("role_id")
  roleName  String         @unique @map("role_name")
  employees EmployeeRole[]
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  @@map("roles")
}

// 3. Bảng employee_roles (Phân quyền vai trò)
model EmployeeRole {
  employee   Employee @relation(fields: [employeeId], references: [employeeId], onDelete: Cascade)
  employeeId Int      @map("employee_id")
  role       Role     @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  roleId     Int      @map("role_id")

  @@id([employeeId, roleId])
  @@map("employee_roles")
}

// 4. Bảng agents (Đại lý)
model Agent {
  agentId     Int          @id @default(autoincrement()) @map("agent_id")
  agentName   String       @map("agent_name")
  phoneNumber String?      @unique @map("phone_number")
  email       String?      @unique
  address     String
  salesOrders SalesOrder[]
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  @@index([agentName])
  @@map("agents")
}

// 5. Bảng suppliers (Nhà cung cấp)
model Supplier {
  supplierId     Int             @id @default(autoincrement()) @map("supplier_id")
  code           String          @unique // NEW: Required for Barcode
  supplierName   String          @map("supplier_name")
  phoneNumber    String?         @unique @map("phone_number")
  email          String?         @unique
  address        String
  purchaseOrders PurchaseOrder[]
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  suppliedComponents SupplierComponent[] // Relation for filtering

  @@index([supplierName])
  @@map("suppliers")
}

// 6. Bảng customers (Khách hàng)
model Customer {
  customerId   Int        @id @default(autoincrement()) @map("customer_id")
  customerName String     @map("customer_name")
  phoneNumber  String?    @unique @map("phone_number")
  email        String?    @unique
  
  address      String?

  warranties   Warranty[]
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  @@index([customerName])
  @@map("customers")
}

// 7. Bảng product_categories (Danh mục sản phẩm)
model ProductCategory {
  categoryId   Int       @id @default(autoincrement()) @map("category_id")
  categoryName String    @map("category_name")
  description  String?
  products     Product[]
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("product_categories")
}

// 8. Bảng products (Sản phẩm)
model Product {
  productId          Int                   @id @default(autoincrement()) @map("product_id")
  code               String                @unique // NEW: PRD-001
  productName        String                @map("product_name")
  categoryId         Int?                  @map("category_id")
  unit               String                // NEW
  category           ProductCategory?      @relation(fields: [categoryId], references: [categoryId], onDelete: SetNull)
  composition        ProductComposition[]
  salesOrderDetails  SalesOrderDetail[]
  productionRequests ProductionRequest[]
  productInstances   ProductInstance[]
  
  // Back relation for WorkOrders
  workOrders         WorkOrder[]

  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")

  @@index([productName])
  @@map("products")
}

// 9. Bảng components (Linh kiện)
model Component {
  componentId           Int                    @id @default(autoincrement()) @map("component_id")
  code                  String                 @unique // NEW: Required for Barcode (COM-001)
  componentName         String                 @map("component_name")
  description           String?
  unit                  String                 // NEW: (kg, pcs)
  minStockLevel         Int                    @default(0) @map("min_stock_level") // NEW: Alerting
  standardCost          Decimal                @default(0) @db.Decimal(10, 2) @map("standard_cost")

  productComposition    ProductComposition[]
  purchaseOrderDetails  PurchaseOrderDetail[]
  componentStocks       ComponentStock[]
  inventoryTransactions InventoryTransaction[]
  materialReqDetails    MaterialRequestDetail[] 
  suppliedBy         SupplierComponent[] // Relation
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")

  @@index([componentName])
  @@map("components")
}

// 10. Bảng product_composition (Cấu thành sản phẩm)
model ProductComposition {
  product        Product   @relation(fields: [productId], references: [productId], onDelete: Cascade)
  productId      Int       @map("product_id")
  component      Component @relation(fields: [componentId], references: [componentId], onDelete: Cascade)
  componentId    Int       @map("component_id")
  quantityNeeded Decimal   @map("quantity_needed") @db.Decimal(10, 4) // Changed to Decimal for precision


  @@id([productId, componentId])
  @@map("product_composition")
}

// 11. Bảng purchase_orders (Đơn đặt hàng nhà cung cấp)
model PurchaseOrder {
  purchaseOrderId      Int                     @id @default(autoincrement()) @map("purchase_order_id")
  code                 String                  @unique 
  orderDate            DateTime                @default(now()) @map("order_date")
  status               OrderStatus             @default(PENDING)
  totalAmount          Decimal                 @default(0) @db.Decimal(15, 2) @map("total_amount")
  discount             Decimal                 @default(0) @db.Decimal(15, 2) // Added
  shippingCost         Decimal                 @default(0) @db.Decimal(15, 2) @map("shipping_cost")
  tax                  Decimal                 @default(0) @db.Decimal(15, 2) 

  paymentTerms         String?                 @map("payment_terms")
  deliveryTerms        String?                 @map("delivery_terms")
  expectedDeliveryDate DateTime?               @map("expected_delivery_date")
  priority             Priority                @default(MEDIUM)

  employeeId           Int                     @map("employee_id")
  supplierId           Int                     @map("supplier_id")
  employee             Employee                @relation("POCreator", fields: [employeeId], references: [employeeId])
  supplier             Supplier                @relation(fields: [supplierId], references: [supplierId], onDelete: Restrict)
  details              PurchaseOrderDetail[]
  createdAt            DateTime                @default(now()) @map("created_at")
  updatedAt            DateTime                @updatedAt @map("updated_at")
  
  // Approver (The Manager who said "Yes")
  approverId           Int?                    @map("approver_id") // NEW
  approvedAt           DateTime?               @map("approved_at") // NEW
  approver             Employee?               @relation("POApprover", fields: [approverId], references: [employeeId])

  // Relation to Inventory Transactions (For history tracking)
  inventoryTransactions InventoryTransaction[] // This already exists in your schema but needs the other side updated
  
  @@map("purchase_orders")
}

// 12. Bảng purchase_order_details (Chi tiết đơn đặt hàng NCC)
model PurchaseOrderDetail {
  poDetailId      Int           @id @default(autoincrement()) @map("po_detail_id") // NEW: ID for easier tracking
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [purchaseOrderId], onDelete: Cascade)
  purchaseOrderId Int           @map("purchase_order_id")
  component       Component     @relation(fields: [componentId], references: [componentId])
  componentId     Int           @map("component_id")
  quantityOrdered Int           @map("quantity_ordered") // Renamed from quantity
  quantityReceived Int          @default(0) @map("quantity_received") // NEW: Track partials
  
  unitPrice       Decimal       @db.Decimal(10, 2) @map("unit_price")
  
  @@unique([purchaseOrderId, componentId]) 
  @@map("purchase_order_details")
}

// 13. Bảng sales_orders (Đơn hàng)
model SalesOrder {
  salesOrderId Int                @id @default(autoincrement()) @map("sales_order_id")
  orderDate    DateTime           @default(now()) @map("order_date")
  status       OrderStatus        @default(PENDING)
  employeeId   Int                @map("employee_id")
  agentId      Int                @map("agent_id")
  employee     Employee           @relation(fields: [employeeId], references: [employeeId])
  agent        Agent              @relation(fields: [agentId], references: [agentId])
  details      SalesOrderDetail[]
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  @@map("sales_orders")
}

// 14. Bảng sales_order_details (Chi tiết đơn hàng)
model SalesOrderDetail {
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [salesOrderId], onDelete: Cascade)
  salesOrderId Int        @map("sales_order_id")
  product      Product    @relation(fields: [productId], references: [productId])
  productId    Int        @map("product_id")
  quantity     Int
  salePrice    Decimal    @db.Decimal(10, 2) @map("sale_price")

  @@id([salesOrderId, productId])
  @@map("sales_order_details")
}

// 15. Bảng production_requests (Yêu cầu sản xuất)
model ProductionRequest {
  productionRequestId   Int                      @id @default(autoincrement()) @map("production_request_id")
  code                  String                   @unique // NEW
  requestDate           DateTime                 @default(now()) @map("request_date")
  status                ProductionStatus         @default(REQUESTED)
  
  priority              Priority                 @default(MEDIUM)

  quantity              Int
  employeeId            Int                      @map("employee_id")
  productId             Int                      @map("product_id")
  employee              Employee                 @relation(fields: [employeeId], references: [employeeId])
  product               Product                  @relation(fields: [productId], references: [productId])
  workOrderFulfillments WorkOrderFulfillment[]
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  @@map("production_requests")
}

// 16. Bảng production_lines (Dây chuyền sản xuất)
model ProductionLine {
  productionLineId  Int               @id @default(autoincrement()) @map("production_line_id")
  lineName          String            @map("line_name")
  location          String?
  productionBatches ProductionBatch[]
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  @@map("production_lines")
}

// 17. Bảng work_orders (Lệnh sản xuất)
model WorkOrder {
  workOrderId           Int                      @id @default(autoincrement()) @map("work_order_id")
  code                  String                   @unique // NEW: WO-001
  createDate            DateTime                 @default(now()) @map("create_date")
  status                ProductionStatus         @default(DRAFT) // Changed default
  quantity              Int                      // NEW: Planned Qty

  employeeId            Int                      @map("employee_id")
  
  productId             Int                      @map("product_id")
  product               Product                  @relation(fields: [productId], references: [productId])

  employee              Employee                 @relation(fields: [employeeId], references: [employeeId])
  workOrderFulfillments WorkOrderFulfillment[]
  productionBatches     ProductionBatch[]
  productionCosts       ProductionCost[]
  materialRequests      MaterialExportRequest[]
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  @@map("work_orders")
}

// 18. Bảng work_order_fulfillments (Thực thi yêu cầu sản xuất)
model WorkOrderFulfillment {
  workOrder           WorkOrder         @relation(fields: [workOrderId], references: [workOrderId], onDelete: Cascade)
  workOrderId         Int               @map("work_order_id")
  productionRequest   ProductionRequest @relation(fields: [productionRequestId], references: [productionRequestId], onDelete: Cascade)
  productionRequestId Int               @map("production_request_id")

  @@id([workOrderId, productionRequestId])
  @@map("work_order_fulfillments")
}

// 19. Bảng production_batches (Lô sản xuất)
model ProductionBatch {
  productionBatchId Int               @id @default(autoincrement()) @map("production_batch_id")
  batchCode         String            @unique @map("batch_code")
  productionDate    DateTime          @map("production_date")
  expiryDate        DateTime?         @map("expiry_date")
  workOrderId       Int               @map("work_order_id")
  productionLineId  Int?              @map("production_line_id") // Made Optional
  workOrder         WorkOrder         @relation(fields: [workOrderId], references: [workOrderId])
  productionLine    ProductionLine?   @relation(fields: [productionLineId], references: [productionLineId])
  productInstances  ProductInstance[]
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  @@map("production_batches")
}



// 20. Bảng product_instances (Sản phẩm cụ thể)
model ProductInstance {
  productInstanceId     Int                    @id @default(autoincrement()) @map("product_instance_id")
  serialNumber          String                 @unique @map("serial_number")
  status                ProductInstanceStatus  @default(IN_STOCK)
  unitProductionCost    Decimal?               @db.Decimal(10, 2) @map("unit_production_cost")
  productId             Int                    @map("product_id")
  productionBatchId     Int                    @map("production_batch_id")
  product               Product                @relation(fields: [productId], references: [productId])
  productionBatch       ProductionBatch        @relation(fields: [productionBatchId], references: [productionBatchId])
  warranty              Warranty?
  qualityChecks         QualityCheck[]
  inventoryTransactions InventoryTransaction[]
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")

  @@map("product_instances")
}

// 21. Bảng warranties (Bảo hành)
model Warranty {
  warrantyId        Int             @id @default(autoincrement()) @map("warranty_id")
  activationDate    DateTime        @map("activation_date")
  expiryDate        DateTime        @map("expiry_date")
  productInstanceId Int             @unique @map("product_instance_id")
  customerId        Int             @map("customer_id")
  productInstance   ProductInstance @relation(fields: [productInstanceId], references: [productInstanceId])
  customer          Customer        @relation(fields: [customerId], references: [customerId])
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  @@map("warranties")
}

// 22. Bảng quality_checklists (Danh mục kiểm tra chất lượng)
model QualityChecklist {
  checklistId   Int            @id @default(autoincrement()) @map("checklist_id")
  checklistName String         @map("checklist_name")
  description   String?
  qualityChecks QualityCheck[]
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  @@map("quality_checklists")
}

// 23. Bảng quality_checks (Kiểm tra chất lượng)
model QualityCheck {
  qualityCheckId    Int                @id @default(autoincrement()) @map("quality_check_id")
  checkDate         DateTime           @default(now()) @map("check_date")
  result            QualityCheckResult
  notes             String?
  employeeId        Int                @map("employee_id")
  productInstanceId Int                @map("product_instance_id")
  checklistId       Int                @map("checklist_id")
  employee          Employee           @relation(fields: [employeeId], references: [employeeId])
  productInstance   ProductInstance    @relation(fields: [productInstanceId], references: [productInstanceId])
  checklist         QualityChecklist   @relation(fields: [checklistId], references: [checklistId])
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  @@map("quality_checks")
}

// 24. Bảng warehouses (Kho hàng)
model Warehouse {
  warehouseId           Int                    @id @default(autoincrement()) @map("warehouse_id")
  code                  String                 @unique // NEW: Barcode (WH-01)
  warehouseName         String                 @map("warehouse_name")
  location              String?
  componentStocks       ComponentStock[]
  inventoryTransactions InventoryTransaction[]
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")

  @@map("warehouses")
}

// 25. Bảng component_stock (Tồn kho linh kiện)
model ComponentStock {
  warehouse   Warehouse @relation(fields: [warehouseId], references: [warehouseId])
  warehouseId Int       @map("warehouse_id")
  component   Component @relation(fields: [componentId], references: [componentId])
  componentId Int       @map("component_id")
  quantity    Int
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@id([warehouseId, componentId])
  @@map("component_stocks")
}

// 26. Bảng inventory_transactions (Giao dịch kho)
model InventoryTransaction {
  transactionId     Int                      @id @default(autoincrement()) @map("transaction_id")
  transactionDate   DateTime                 @default(now()) @map("transaction_date")
  transactionType   InventoryTransactionType @map("transaction_type")
  quantity          Int
  note              String?
  employeeId        Int                      @map("employee_id")
  warehouseId       Int                      @map("warehouse_id")
  componentId       Int?                     @map("component_id")
  productInstanceId Int?                     @map("product_instance_id")
  materialReqId     Int?                     @map("material_req_id") // NEW: Link to Request
  employee          Employee                 @relation(fields: [employeeId], references: [employeeId])
  warehouse         Warehouse                @relation(fields: [warehouseId], references: [warehouseId])
  component         Component?               @relation(fields: [componentId], references: [componentId])
  productInstance   ProductInstance?         @relation(fields: [productInstanceId], references: [productInstanceId])
  materialReq       MaterialExportRequest?   @relation(fields: [materialReqId], references: [requestId])
  purchaseOrderId   Int?                     @map("purchase_order_id") // NEW
  purchaseOrder     PurchaseOrder?           @relation(fields: [purchaseOrderId], references: [purchaseOrderId])

  @@index([transactionType])
  @@index([transactionDate])
  @@map("inventory_transactions")
}

// 27. Bảng cost_categories (Loại chi phí)
model CostCategory {
  costCategoryId  Int              @id @default(autoincrement()) @map("cost_category_id")
  categoryName    String           @map("category_name")
  description     String?
  productionCosts ProductionCost[]
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  @@map("cost_categories")
}

// 28. Bảng production_costs (Chi phí sản xuất)
model ProductionCost {
  productionCostId Int          @id @default(autoincrement()) @map("production_cost_id")
  amount           Decimal      @db.Decimal(12, 2)
  description      String?
  workOrderId      Int          @map("work_order_id")
  costCategoryId   Int          @map("cost_category_id")
  workOrder        WorkOrder    @relation(fields: [workOrderId], references: [workOrderId], onDelete: Cascade)
  costCategory     CostCategory @relation(fields: [costCategoryId], references: [costCategoryId])
  createdAt        DateTime     @default(now()) @map("created_at")

  @@map("production_costs")
}

// 29.  
model SupplierComponent {
  supplier    Supplier  @relation(fields: [supplierId], references: [supplierId], onDelete: Cascade)
  supplierId  Int       @map("supplier_id")
  component   Component @relation(fields: [componentId], references: [componentId], onDelete: Cascade)
  componentId Int       @map("component_id")

  // REMOVED: supplierSku, price, currency (Per your request)
  createdAt   DateTime  @default(now()) @map("created_at")

  @@id([supplierId, componentId]) // Composite Key
  @@map("supplier_components")
}

// 30.
model MaterialExportRequest {
  requestId     Int           @id @default(autoincrement()) @map("material_req_id")
  code          String        @unique // e.g. "REQ-MAT-001"
  requestDate   DateTime      @default(now()) @map("request_date")
  status        RequestStatus @default(PENDING)
  note          String?
  
  workOrderId   Int           @map("work_order_id")
  requesterId   Int           @map("requester_id")
  approverId    Int?          @map("approver_id")
  
  workOrder     WorkOrder     @relation(fields: [workOrderId], references: [workOrderId])
  requester     Employee      @relation("Requester", fields: [requesterId], references: [employeeId])
  approver      Employee?     @relation("Approver", fields: [approverId], references: [employeeId])
  
  details       MaterialRequestDetail[]
  transactions  InventoryTransaction[]

  @@map("material_export_requests")
}


// 31.
model MaterialRequestDetail {
  detailId      Int                   @id @default(autoincrement())
  requestId     Int                   @map("material_req_id")
  componentId   Int                   @map("component_id")
  quantity      Int
  
  request       MaterialExportRequest @relation(fields: [requestId], references: [requestId], onDelete: Cascade)
  component     Component             @relation(fields: [componentId], references: [componentId])

  @@map("material_request_details")
}